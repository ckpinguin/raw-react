<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>I'm in a react app!</title>
    <script type="text/javascript" src="react.js"></script>
    <script type="text/javascript" src="react-dom.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="react-app"></div>
    <script type="text/javascript">

    var ContactView = React.createClass({
        propTypes: {
            contacts: React.PropTypes.array.isRequired,
            newContact: React.PropTypes.object.isRequired,
            handleContactChange: React.PropTypes.func.isRequired,
            handleSaveContact: React.PropTypes.func.isRequired
        },
        render: function() {
            var contactItemElements = this.props.contacts
                .filter(function(contact) { return contact.email; })
                .map(function(contact) { // Array is a functor, map returns same-size array
                    return React.createElement(ContactItem, contact);
            });
            return (
                React.createElement('div', {className: 'ContactView'},
                    React.createElement('h1', {className: 'ContactView-title'}, 'Contacts'),
                    React.createElement('ul', {className: 'ContactView-list'}, contactItemElements),
                    React.createElement(ContactForm, {
                        value: this.props.newContact,
                        onChange: this.props.handleContactChange,
                        onSubmit: this.props.handleSaveContact
                    })
                )
            );
        }
    });

    var ContactItem = React.createClass({
        propTypes: {
            name: React.PropTypes.string.isRequired,
            email: React.PropTypes.string,
            description: React.PropTypes.string
        },
        render: function() {
            return (React.createElement('li', {
                className: 'ContactItem'
            }, React.createElement('h2', {
                className: 'ContactItem-name'
            }, this.props.name), React.createElement('a', {
                className: 'ContactItem-email',
                href: 'mailto:' + this.props.email
            }, this.props.email), React.createElement('p', {
                className: 'ContactItem-description'
            }, this.props.description)));
        }
    });

    var ContactForm = React.createClass({
        propTypes: {
            value: React.PropTypes.object.isRequired,
            onChange: React.PropTypes.func.isRequired,
            onSubmit: React.PropTypes.func.isRequired
        },
        onNameChange: function(event) {
            this.props.onChange(
                Object.assign({},
                 this.props.value,
                 {name: event.target.value})
             )
        },
        onEmailChange: function(event) {
            this.props.onChange(
                Object.assign({},
                 this.props.value,
                 {email: event.target.value})
             )
        },
        onDescriptionChange: function(event) {
            this.props.onChange(
                Object.assign({},
                 this.props.value,
                 {description: event.target.value})
             )
        },
        onSubmit: function(event) {
            event.preventDefault();
            this.props.onSubmit(); // no arg needed
        },
        onNameFocus: function() {
            console.log('haha, denied!');
            this.refs.name.blur(); // haha!
        },
        componentWillUpdate: function(nextProps, nextState) {
            console.log('componentWillUpdate');
        },
        render: function() {
            var errors = this.props.value.errors || {};
            return (
                React.createElement('form', {
                className: 'ContactForm',
                onSubmit: this.onSubmit,
                noValidate: true // For development we want to validate ourselves in the handler
                },
                    React.createElement('input', {
                        className: errors.name && 'ContactForm-error',
                        placeholder: 'Name (required)',
                        ref: 'name',
                        //onFocus: this.onNameFocus,
                        type: 'text',
                        value: this.props.value.name,
                        onChange: this.onNameChange
                    }),
                    React.createElement('input', {
                        className: errors.email && 'ContactForm-error',
                        placeholder: 'Email',
                        type: 'email',
                        value: this.props.value.email,
                        onChange: this.onEmailChange
                    }),
                    React.createElement('textarea', {
                        className: errors.description && 'ContactForm-error',
                        placeholder: 'Description',
                        value: this.props.value.description,
                        onChange: this.onDescriptionChange
                    }),
                    React.createElement('button', {
                        type: 'submit'
                    }, 'Add Contact')
                )
            );
        }
    });

    /*
    * Constants
    */
    var CONTACT_TEMPLATE = {name: '', email: '', description: '', errors: null};

    /*
    * Actions
    */

    function updateNewContact(contact) {
        // React automatically merges partial state into the current state
        setState({ newContact: contact });
    }

    function submitNewContact() {
        var contact = Object.assign({},
            state.newContact, // filled only if the form component has submitted stuff
            {
                key: state.contacts.length + 1, // incremented key analogue to array's idx
                errors: {}
            }
        );
        // validation
        if (!contact.name) {
            contact.errors.name = ['Please enter your new contact\.s name'];
            console.log('error with name: ' + contact.errors.name);
        }
        if (!/.+@.+\..+/.test(contact.email)) {
            contact.errors.email = ['Please enter your new contact\'s email'];
            console.log('error with email: ' + contact.errors.email);
        }

        setState(
            // No validation errors?
            Object.keys(contact.errors).length === 0
            ? {
                newContact: Object.assign({}, CONTACT_TEMPLATE),
                contacts: state.contacts.slice(0).concat(contact)
              }
            : { newContact: contact } // newContact returned the same (from the form with errors)
        );
    }

    /*
    * Model
    */

    // The app's current state
    var state = {};

    // setting stage triggers rerendering
    function setState(changes) {
        Object.assign(state, changes);

        ReactDOM.render(
            // Packing everything in a new props object by using Object.assign
            React.createElement(ContactView,
                Object.assign(
                    {}, state, {
                    handleContactChange: updateNewContact,
                    handleSaveContact: submitNewContact
                    }
                )
            ),
            document.getElementById('react-app')
        );
    }

    // Set initial data first time (implicit rendering)
    setState({
        contacts: [
            {
                key: 1,
                name: 'Chrigi KÃ¤lin',
                email: 'ckpinguin@gmail.com',
                description: 'Front-end noob'
            }, {
                key: 2,
                name: 'Johnny Cash',
                email: 'johnny@cash.com'
            }, {
                key: 3,
                name: 'Joe Jim'
            }
        ],
        newContact: Object.assign({}, CONTACT_TEMPLATE)
    });


    </script>
</body>
</html>
